---
title: "sts get-session-tokenã‚’å®Ÿè¡Œã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã‚‹PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
emoji: "ğŸ“²"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "powershell"]
published: true
---

# æ¦‚è¦

`aws sts get-session-token`ã‚’å®Ÿè¡Œã—ãŸå¾Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¨­å®šã‚’ã™ã‚‹ã®ãŒç…©ã‚ã—ã„ã®ã§ã€
PowerShell ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ Copilot ã«çµ„ã‚“ã§ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚

# PowerShell ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```ps1:aws_start_session.ps1
param(
    [Parameter(Mandatory=$true)]
    [ValidatePattern("^\d{6}$")]
    [string]$SixDigitNumber
)

# MFAãƒ‡ãƒã‚¤ã‚¹ã®ARNã‚’å®šæ•°ã¨ã—ã¦å®šç¾©
$MfaDeviceArn = "arn:aws:iam::********:mfa/*****"

# AWS CLIã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
$session = aws sts get-session-token --serial-number $MfaDeviceArn --token-code $SixDigitNumber --output json | ConvertFrom-Json

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
$env:AWS_ACCESS_KEY_ID = $session.Credentials.AccessKeyId
$env:AWS_SECRET_ACCESS_KEY = $session.Credentials.SecretAccessKey
$env:AWS_SESSION_TOKEN = $session.Credentials.SessionToken
```

# ä½¿ã„æ–¹

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’`aws_start_session.ps1`ã¨ã—ãŸæ™‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ç”¨

```powershell
.\aws_start_session.ps1 ******(MFAã®ç¢ºèªã‚³ãƒ¼ãƒ‰)
```

ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã‘ã‚Œã°ä»¥é™ã€PowerShell ã‚’é–‰ã˜ã‚‹ã¾ã§å–å¾—ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã§
aws cli ã‚’ä½¿ç”¨ã§ãã¾ã™

# æ”¹å–„ç‚¹

ä»¥ä¸‹ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã‚ˆã‚Šä½¿ã„ã‚„ã™ããªã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™

- å¼•æ•°ã§ profile ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- `iam get-user`ã€`iam list-mfa-devices` ã‚’çµ„ã¿åˆã‚ã›ã¦è‡ªèº«ã® MFA ã® ARN ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è©³ç´°åŒ–

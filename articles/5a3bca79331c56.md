---
title: "Terraformã®backendè¨­å®šã‚’.tfãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åˆ†é›¢ã™ã‚‹æ–¹æ³•ã¾ã¨ã‚"
emoji: "ğŸï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform"]
published: true
---

# æ¦‚è¦

åŒã˜ Terraform ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰è¤‡æ•°ã®ç’°å¢ƒã‚’ä½œæˆã™ã‚‹ãŸã‚ã€
`.tf`ãƒ•ã‚¡ã‚¤ãƒ«ã« backend ã®è¨­å®šã‚’è¨˜è¼‰ã›ãšã«`.tfbackend`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦å®šç¾©ã—ã‚ˆã†ã¨ã—ãŸã¨ã“ã‚å°‘ã—ãƒãƒã‚Šã¾ã—ãŸã€‚

åŸå› ã¨ãã‚‚ãã‚‚ã® backend å®šç¾©ã®ãƒ«ãƒ¼ãƒ«ç†è§£ã®ãŸã‚ã€
terraform ã® backend ã«é–¢ã—ã¦æ·±æ˜ã‚Šã—ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚

:::details ãƒãƒã£ãŸæ™‚ã®çŠ¶æ³

å€‹äººé–‹ç™ºã§ backend ã®è¨­å®šã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢ã—ãŸãã€ä»¥ä¸‹ã®ã‚ˆã†ã«è©¦ã—ã¾ã—ãŸã€‚
çµæœã€backend ãŒ local æ‰±ã„ã«ã•ã‚Œã¦ãƒãƒã‚Šã¾ã—ãŸã€‚

https://zenn.dev/link/comments/81a6eb77ddd22a

main.tf ã«ã¯ç‰¹ã« backend ãƒ–ãƒ­ãƒƒã‚¯ã®å®šç¾©ã¯ãªã—

```tf:main.tf
# ------------------------
# - Terraform configuratoions
# ------------------------
terraform {
  required_version = ">1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~>3.0"
    }
  }
}
```

dev ç’°å¢ƒç”¨ã® tfbackend ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```tf:backend/dev.tfbackend
bucket = ****
key    = "****dev.tfstate"
region = "ap-northeast-1"
profile = ****
```

ä½œæˆã—ãŸ tfbackend ã‚’ä½¿ç”¨ã—ã¦ terraform init

```shell
terraform init -reconfigure -backend-config="backend/dev.tfbackend"
```

warn ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
backend ã®å®šç¾©ãŒè¦‹ã¤ã‹ã‚‰ãšã€local æ‰±ã„ã«ãªã£ã¦ã„ãŸã€‚

`-backend-config`ã®è¨­å®šã ã‘ã§ã¯ã ã‚ã ã£ãŸã£ã½ã„ã€‚

```
Initializing the backend...

Initializing provider plugins...
- Reusing previous version of hashicorp/aws from the dependency lock file
- Using previously-installed hashicorp/aws v3.76.1

â•·
â”‚ Warning: Missing backend configuration
â”‚
â”‚ -backend-config was used without a "backend" block in the configuration.
â”‚
â”‚ If you intended to override the default local backend configuration,
â”‚ no action is required, but you may add an explicit backend block to your
â”‚ configuration to clear this warning:
â”‚
â”‚ terraform {
â”‚   backend "local" {}
â”‚ }
â”‚
â”‚ However, if you intended to override a defined backend, please verify that
â”‚ the backend configuration is present and valid.
â”‚
â•µ
```

main.tf ã« backend ã®è¨­å®šã‚’è¨˜è¼‰ã™ã‚‹ã¨è§£æ±ºã—ã¾ã—ãŸã€‚

```tf:main.tf
# ------------------------
# - Terraform configuratoions
# ------------------------
terraform {
  required_version = ">1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~>3.0"
    }
  }
  backend "s3" {
    bucket = ****
    key    = "****dev.tfstate"
    region = "ap-northeast-1"
    profile = ****
  }
}
```

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developer.hashicorp.com/terraform/language/settings/backends/configuration#default-backend)ã«ã¯ä¸‹è¨˜ã®è¨˜è¼‰ãŒã‚ã£ãŸ

> If a configuration includes no backend block, Terraform defaults to using the `local` backend, which stores state as a plain file in the current working directory.

ãã‚‚ãã‚‚`.tf`ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç¨®é¡ã¨ã—ã¦ s3 ã‚’æŒ‡å®šã—ã¦ã„ãªã‹ã£ãŸã®ã§å½“ç„¶ã¨ã„ãˆã°å½“ç„¶ã€‚
:::

ä»¥ä¸‹ã€å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚
https://developer.hashicorp.com/terraform/language/settings/backends/configuration

# ãã‚‚ãã‚‚ Terraform ã«ãŠã‘ã‚‹ backend ã¨ã¯

Terraform ã® tfstate ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜å ´æ‰€ã‚’å®šç¾©ã™ã‚‹ã‚‚ã®ã€‚
Terraform ã¯ tfstate ã‚’ä½¿ã£ã¦ç®¡ç†ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ç¾¤ã®çŠ¶æ…‹ã‚’è¿½è·¡ã™ã‚‹ã€‚

Terraform Cloud ã¨çµ±åˆã™ã‚‹ã‹ã€backend ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§
è¤‡æ•°å€‹æ‰€ã‹ã‚‰å…±é€šã® tfstate ã«ã‚¢ã‚¯ã‚»ã‚¹ã€ã™ãªã‚ã¡å…±é€šã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

# backend ã®ç¨®é¡

è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠãŒå¯èƒ½ã€‚

é¸æŠã—ãŸã‚‚ã®ã«ã‚ˆã£ã¦ãŸã ã®ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚¯ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã‚‹ã‚‚ã®ã‚„ã€
æ“ä½œä¸­ã« state ã®ãƒ­ãƒƒã‚¯ãŒã§ãã‚‹ã‚‚ã®ã‚‚ã‚ã‚‹ã€‚

ä¾‹ãˆã°`s3`ã® backend ã¯`DynamoDB`ã‚’ä»‹ã™ã‚‹ã“ã¨ã§ãƒ­ãƒƒã‚¯ã¨ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ã‚µãƒãƒ¼ãƒˆã‚‚å¯èƒ½ã€‚

# backend ã®è¨­å®š

Terraform Cloud ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯è‡ªå‹•çš„ã« state ã‚’ç®¡ç†ã—ã¦ãã‚Œã‚‹ã®ã§ã€backend ã®è¨­å®šã¯ä¸è¦ã€‚

è¨­å®šã™ã‚‹å ´åˆã€ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã® terraform ãƒ–ãƒ­ãƒƒã‚¯å†…ã«ãƒã‚¹ãƒˆã—ãŸ backend ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã€‚

backend ãƒ–ãƒ­ãƒƒã‚¯ã§ä½¿ã‚ã‚Œã‚‹å¼•æ•°ã¯ã€é¸æŠã—ãŸ backend ã®ç¨®é¡ã®å›ºæœ‰ã®ã‚‚ã®

```tf
terraform {
  required_version = ">1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~>3.0"
    }
  }
  # terraformãƒ–ãƒ­ãƒƒã‚¯ã«ãƒã‚¹ãƒˆã—ãŸbackendãƒ–ãƒ­ãƒƒã‚¯
  backend "s3" {
    bucket = ****
    key    = "****dev.tfstate"
    region = "ap-northeast-1"
    profile = ****
  }
}
```

ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã« state ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã®äººã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

æ©Ÿå¯†æ€§ãŒé«˜ã„æƒ…å ±(ARN ã‚„ DB ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰)ãŒå«ã¾ã‚Œã‚‹ã®ã§ã€ãƒªãƒ¢ãƒ¼ãƒˆã® state ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹èªè¨¼æƒ…å ±ãŒè¦ã‚‹ã€‚
AWS ã§ã‚ã‚Œã°ã€profile åã‚’æŒ‡å®šã™ã‚‹ç­‰ã€‚

# backend ãƒ–ãƒ­ãƒƒã‚¯ã®å¼•æ•°ã«ã¤ã„ã¦

backend ãƒ–ãƒ­ãƒƒã‚¯ã§å¿…è¦ãªå¼•æ•°ã‚’ã™ã¹ã¦æŒ‡å®šã™ã‚‹å¿…è¦ã¯ãªã„ã€‚
ãŸã ã—ã€çœç•¥ã•ã‚ŒãŸå¼•æ•°ã¯ `init` ã§æä¾›ã•ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚
å¼•æ•°ã‚’çœç•¥ã™ã‚‹å ´åˆã¯æœ€ä½ã§ã‚‚ç©ºã® backend æ§‹æˆã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```tf
terraform {
  backend "s3" {
  }
}
```

æœ€çµ‚çš„ãªè¨­å®šã¯`.terraform`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ä¿å­˜ã•ã‚Œã‚‹ã€‚
`.terraform`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯åŸºæœ¬çš„ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‹ã‚‰é™¤å¤–ã•ã‚Œã‚‹ã€‚

## backend ãƒ–ãƒ­ãƒƒã‚¯ã§çœç•¥ã•ã‚ŒãŸå¼•æ•°ã‚’`init`ã§æä¾›ã™ã‚‹ä¾‹

:::details ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’ä¸€ã¤æŒ‡å®šã™ã‚‹å ´åˆ

```tf
terraform {
  required_version = ">1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~>3.0"
    }
  }
  backend "s3" {
    bucket = ****
    # keyã‚’çœç•¥
    region = "ap-northeast-1"
    profile = ****
  }
}
```

```shell
terraform init -backend-config="key=dev.tfstate"
```

:::

:::details å¯¾è©±çš„å…¥åŠ›

å¯¾è©±çš„å…¥åŠ›ãŒç„¡åŠ¹ã§ãªã‘ã‚Œã°ã€å¿…è¦ãªå€¤ã‚’è³ªå•ã—ã¦ãã‚‹ã€‚

```tf
terraform {
  required_version = ">1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~>3.0"
    }
  }
  backend "s3" {
    # bucketã¨keyã‚’çœç•¥
    region = "ap-northeast-1"
    profile = ****
  }
}
```

```shell
> terraform init

Initializing the backend...
Backend configuration changed!

Terraform has detected that the configuration specified for the backend
has changed. Terraform will now check for existing state in the backends.

bucket
  The name of the S3 bucket

  Enter a value: {bucketã‚’å…¥åŠ›}

key
  The path to the state file inside the bucket

  Enter a value: {keyã‚’å…¥åŠ›}
```

:::

:::details åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§æŒ‡å®š

backend ãƒ–ãƒ­ãƒƒã‚¯ã®å†…å®¹ã‚’è¨˜è¼‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãã‚Œã‚’æŒ‡å®šã™ã‚‹ã€‚
ãƒ–ãƒ­ãƒƒã‚¯ã§ãƒ©ãƒƒãƒ—ã™ã‚‹å¿…è¦ã¯ãªã„ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«åã¯`*.backendname.tfbackend`(ä¾‹: `config.consul.tfbackend`)ãŒæ¨å¥¨ã€‚

```tfbackend
bucket = ****
key    = "****dev.tfstate"
region = "ap-northeast-1"
profile = ****
```

```tf
terraform {
  required_version = ">1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~>3.0"
    }
  }
  backend "s3" {
    # ãƒ–ãƒ­ãƒƒã‚¯ã ã‘è¨˜è¼‰
  }
}
```

```shell
terraform init -backend-config="{tfbackendãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®š}"
```

:::

:::details ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§æŒ‡å®š

```tf
terraform {
  required_version = ">1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~>3.0"
    }
  }
  backend "s3" {
    # ãƒ–ãƒ­ãƒƒã‚¯ã ã‘è¨˜è¼‰
  }
}
```

```shell
terraform init \
    -backend-config="bucket=****" \
    -backend-config="key=****dev.tfstate" \
    -backend-config="region=ap-northeast-1" \
    -backend-config="profile=****"
```

:::

# çµè«–

`.tf`ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åˆ†é›¢ã™ã‚‹å ´åˆã€
æœ€ä½ã§ã‚‚ç©ºã® backend ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¨˜è¼‰ã—ã€backend ã®ç¨®é¡ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
